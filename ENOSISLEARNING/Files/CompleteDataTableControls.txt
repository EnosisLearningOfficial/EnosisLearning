<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="Index.aspx.cs" Inherits="WebApiApplication.Index" %>

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title>
    <%-- Bootstrap CDN --%>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous"/>
        <!-- DataTables CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet" />

</head>
<body>
    <form id="form1" runat="server">
        <%-- Declare script manager always on top --%>
        <asp:ScriptManager ID="ScriptManager1" runat="server"></asp:ScriptManager>

        <%-- Add Student Modal --%>
        <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="StudentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 id="StudentModalLabel" class="modal-title">Add Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="hidden" id="StudentID" />
                            <label for="Name" class="form-label">Name</label>
                            <input id="Name" type="text" class="form-control"/>
                        </div>
                        <div class="mb-3">
                            <label for="Email" class="form-label">Email</label>
                            <input id="Email" type="text" class="form-control"/>
                        </div>
                        <div class="mb-3">
                            <label for="Course" class="form-label">Course</label>
                            <input id="Course" type="text" class="form-control"/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="btnSave" class="btn btn-primary">Save</button>
                        <button type="button" id="btnUpdate" class="btn btn-success" style="display:none;">Update</button>
                        <button type="button" id="cancel" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
         <%-- Add Student Modal --%>
         <%-- Data table and buttons --%>
        <h3 class="mt-3">Students Record</h3>
        <a id="btnAddNew"  href="#studentModal" class="btn btn-primary mb-3" data-bs-toggle="modal">Add Student</a>


        <%-- Data table --%>
        <table id="tblStudent" class="display table table-bordered" style="width:100%">
           <thead>
               <tr>
                   <th>ID</th>
                   <th>Name</th>
                   <th>Email</th>
                   <th>Course</th>
                   <th>Action</th>
               </tr>
           </thead>
            <tbody></tbody>
        </table>
        
         <%-- Data table and buttons --%>
    </form>
     <!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<%-- Ajax using jquery --%>
    <%-- Load Data table --%>
    <script type="text/javascript">
        $(document).ready(function () {
            //Initiale table
            $('#tblStudent').DataTable({
                "ajax": {
                    "url": "Index.aspx/GetAllStudents",
                    "type": "POST",
                    "contentType": "application/json; cahrset=utf-8",
                    "dataType": "json",
                    "data": function () { return JSON.stringify({}); },
                    "dataSrc": function (json) {
                        console.log(json);//Debugging
                        return json.d.data;
                    }
                },
                "columns": [
                    { "data": "StudentId" },
                    { "data": "Name" },
                    { "data": "Email" },
                    { "data": "Course" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `
                            <a class="fa fa-pencil edit-btn" data-id='${row.StudentId}' href="#" data-bs-target="#studentModal" data-bs-toggle="modal"></a>
                            <a class="fa fa-trash text-danger delete-btn" data-id='${row.StudentId}'></a>
                            `;
                        },
                        "orderable": false,
                        "searchable": false
                    }
                ]
            });
        });


        //Add Record//
        $('#btnSave').click(function () {
            //Save Buuton 
            var name = $('#Name').val().trim();
            var email = $('#Email').val().trim();
            var course = $('#Course').val().trim();
            //Check all Feilds are there
            if (name == "" || email == "" || course == "") {
                alert("Please Fill All the Fields...!");
                return;
            }
            $.ajax({
                "url": "Index.aspx/InsertStudent",
                "type": "POST",
                "data": JSON.stringify({name:name,email:email,course:course}),
                "contentType": "application/json; cahrset=utf-8",
                "dataType": "json",
                success: function (response) {
                    if (response.d == "success") {
                        alert("Student Inserted Successfully...!");
                        $('#studentModal').modal('hide');
                        //Refresh data table
                        $('#tblStudent').DataTable().ajax.reload();
                    }
                    else {
                        alert("Insertion Failed...!");
                    }
                },
                error: function () {
                    alert("Error Server Calling...!");
                }
            });
        });

        //Edit button click
        $(document).on('click', '.edit-btn', function () {
            var id = $(this).data('id');
            $.ajax({
                "url": "Index.aspx/GetStudentById",
                "type": "POST",
                "data": JSON.stringify({ id: id }),
                "contentType": "application/json; cahrset=utf-8",
                "dataType": "json",
                success: function(response){
                    var s = response.d;
                    $('#StudentID').val(s.StudentID);
                    $('#Name').val(s.Name);
                    $('#Email').val(s.Email);
                    $('#Course').val(s.Course);
                    $('#StudentModalLabel').text("Edit Student");
                    $('#btnSave').hide();
                    $('#btnUpdate').show();
                    $('#StudentModal').modal('show');
                },
                error: function() {
                    alert("Failed To Fetch Student..!");
                }
            });
        });

        //Update Student
        $('#btnUpdate').click(function () {
            var id = $('#StudentID').val()
            var name = $('#Name').val();
            var email = $('#Email').val();
            var course = $('#Course').val();

            $.ajax({
                "url": "Index.aspx/UpdateStudent",
                "type": "POST",
                "data": JSON.stringify({ id:parseInt(id),name:name,email:email,course:course }),
                "contentType": "application/json; cahrset=utf-8",
                "dataType": "json",
                success: function (response) {
                    if (response.d == "success") {
                        alert("Student updated successfully.");
                        $('#studentModal').modal('hide');
                        //Refresh data table
                        $('#tblStudent').DataTable().ajax.reload();
                    }
                    else {
                        alert("Update Failed...!");
                    }
                },
                error: function () {
                    alert("Server Error");
                }
            });
        });
    </script>
</body>
</html>






using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Web;
using System.Web.Services;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.WebSockets;

namespace WebApiApplication
{
    public partial class Index : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {

        }
        public class Student
        {
            public int StudentID { get; set; }
            public string Name { get; set; }
            public string Email { get; set; }
            public string Course { get; set; }
        }
        //Get All students
        [WebMethod]
        public static object GetAllStudents()
        {
            string ConectionString = "Data Source=DESKTOP-MPE7G61;Initial Catalog=AspTut;Integrated Security=true;";
            using (SqlConnection Conn = new SqlConnection(ConectionString))
            {
                string query = "select StudentId,Name,Email,Course from Students";
                using(SqlCommand cmd = new SqlCommand(query,Conn))
                {
                    using(SqlDataAdapter sda = new SqlDataAdapter(cmd))
                    {
                        DataTable dt = new DataTable();
                        sda.Fill(dt);
                        List<Dictionary<string, object>> rows = new List<Dictionary<string, object>>();
                        foreach(DataRow dr in dt.Rows)
                        {
                            Dictionary<string, object> row = new Dictionary<string, object>();
                            foreach(DataColumn col in dt.Columns)
                            {
                                row.Add(col.ColumnName, dr[col]);
                            }
                            rows.Add(row);
                        }
                        return new { data = rows };//wrap the data in an object with a property name data.
                    }
                }
            }
        }
        //Insert Student 
        [WebMethod]
        public static string InsertStudent(string name, string email, string course)
        {
            string ConectionString = "Data Source=DESKTOP-MPE7G61;Initial Catalog=AspTut;Integrated Security=true;";
            using (SqlConnection Conn = new SqlConnection(ConectionString))
            {
                string query = "Insert Into Students(Name,Email,Course)values(@Name,@Email,@Course)";
                using(SqlCommand cmd = new SqlCommand(query,Conn))
                {
                    cmd.Parameters.AddWithValue("@Name", name);
                    cmd.Parameters.AddWithValue("@Email", email);
                    cmd.Parameters.AddWithValue("@Course", course);
                    Conn.Open();
                    int rows = cmd.ExecuteNonQuery();
                    Conn.Close();
                    return rows > 0 ? "success" : "error";
                }
            }
        }

        //Get Student By Id for Edit
        [WebMethod]
        public static Student GetStudentById(int id)
        {
            string ConectionString = "Data Source=DESKTOP-MPE7G61;Initial Catalog=AspTut;Integrated Security=true;";
            using(SqlConnection Conn = new SqlConnection(ConectionString))
            {
                string query = "Select StudentID,Name,Email,Course from Students where StudentID=@ID";
                using(SqlCommand cmd = new SqlCommand(query,Conn))
                {
                    cmd.Parameters.AddWithValue("@ID", id);
                    Conn.Open();
                    SqlDataReader reader = cmd.ExecuteReader();
                    if(reader.Read())
                    {
                        return new Student
                        {
                            StudentID = Convert.ToInt32(reader["StudentID"]),
                            Name = reader["Name"].ToString(),
                            Email = reader["Email"].ToString(),
                            Course = reader["Course"].ToString()
                        };
                    }
                }
            }
            return null;
        }
        //Update Student
        [WebMethod]
        public static string UpdateStudent(int id, string name,string email,string course)
        {
            string ConectionString = "Data Source=DESKTOP-MPE7G61;Initial Catalog=AspTut;Integrated Security=true;";
            using(SqlConnection Conn = new SqlConnection(ConectionString))
            {
                string query = "Update Students set Name=@Name,Email=@Email,Course=@Course where StudentID=@ID";
                using(SqlCommand cmd = new SqlCommand(query,Conn))
                {
                    cmd.Parameters.AddWithValue("@ID", id);
                    cmd.Parameters.AddWithValue("@Name", name);
                    cmd.Parameters.AddWithValue("@Email", email);
                    cmd.Parameters.AddWithValue("@Course", course);
                    Conn.Open();
                    int rows = cmd.ExecuteNonQuery();
                    Conn.Close();
                    return rows > 0 ? "success" : "error";
                }
            }
        }
    }
}